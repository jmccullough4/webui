# ğŸ” Device Environment Setup Guide

## Overview

The Warhammer Node license system requires a unique device identifier (`DEVICE_ID`) to enforce licenses properly. This guide explains how the device environment is set up and managed.

## ğŸ¯ How It Works

### **1. Device Registration Process**
When you run `device_registration.py`, it:
1. **Generates a unique device ID** from hardware characteristics (CPU, MAC, disk)
2. **Creates cryptographic keys** for the device
3. **Sets environment variables** in the current process
4. **Creates persistent files** for future use

### **2. Environment Files Created**
- **`/etc/warhammer/device.env`**: Main environment file
- **`/etc/warhammer/systemd.env`**: For systemd services
- **`/etc/warhammer/device_info.json`**: Device information for license requests

### **3. Environment Variables Set**
- `DEVICE_ID`: Primary device identifier
- `WARHAMMER_DEVICE_ID`: Alternative identifier (for compatibility)

## ğŸš€ Setup Instructions

### **Option 1: Full Device Registration (Recommended)**
```bash
cd warhammer-node/backend/wh
sudo python3 device_registration.py
```

This will:
- Generate device keys
- Set environment variables
- Create all necessary files
- Output device info for license requests

### **Option 2: Environment Only**
```bash
cd warhammer-node/backend/wh
sudo python3 device_registration.py --env-only
```

This will:
- Set environment variables only
- Skip key generation
- Useful for existing devices

### **Option 3: Force Regeneration**
```bash
cd warhammer-node/backend/wh
sudo python3 device_registration.py --force
```

This will:
- Regenerate all device keys
- Update environment variables
- Overwrite existing files

## ğŸ” Verification

### **Test Device Environment**
```bash
cd warhammer-node/backend/wh
sudo python3 test_device_environment.py
```

Expected output:
```
ğŸ§ª Testing Device Environment Setup
========================================
ğŸ“ Checking device environment file: /etc/warhammer/device.env
âœ… Device environment file exists
ğŸ“„ File contents:
# Warhammer Node Device Environment
# Generated by device registration script
# Do not edit manually - will be overwritten on device registration

DEVICE_ID=1234567890abcdef1234567890abcdef
WARHAMMER_DEVICE_ID=1234567890abcdef1234567890abcdef

ğŸŒ Checking environment variables:
âœ… DEVICE_ID: 1234567890abcdef1234567890abcdef
âœ… WARHAMMER_DEVICE_ID: 1234567890abcdef1234567890abcdef

ğŸ“Š Checking device info file: /etc/warhammer/device_info.json
âœ… Device info file exists
âœ… Device ID from file: 1234567890abcdef1234567890abcdef
âœ… Environment and file device IDs match!

ğŸ”’ Testing license decorator import:
âœ… License decorators imported successfully
âœ… get_current_device_id() returned: 1234567890abcdef1234567890abcdef

========================================
ğŸ‰ Device environment is properly configured!
```

### **Manual Verification**
```bash
# Check environment file
sudo cat /etc/warhammer/device.env

# Check device info
sudo cat /etc/warhammer/device_info.json

# Check environment variables
echo "DEVICE_ID: $DEVICE_ID"
echo "WARHAMMER_DEVICE_ID: $WARHAMMER_DEVICE_ID"
```

## ğŸ”§ How License Decorators Use Device ID

### **Priority Order**
1. **Request Headers**: `X-Device-ID` (for multi-device scenarios)
2. **Environment Variables**: `DEVICE_ID` or `WARHAMMER_DEVICE_ID`
3. **Flask Config**: `app.config['DEVICE_ID']`
4. **Device Info File**: `/etc/warhammer/device_info.json`
5. **System Generation**: Fallback to hardware-based ID

### **Automatic Loading**
The license decorators automatically:
- Load environment variables from `/etc/warhammer/device.env`
- Cache the device ID for performance
- Fall back to alternative sources if needed

## ğŸ“ File Structure

```
/etc/warhammer/
â”œâ”€â”€ device.env              # Environment variables
â”œâ”€â”€ systemd.env             # Systemd environment
â”œâ”€â”€ device_info.json        # Device information
â”œâ”€â”€ device_keys/            # Cryptographic keys
â”‚   â””â”€â”€ {device_id}/
â”‚       â”œâ”€â”€ private_key.pem
â”‚       â”œâ”€â”€ public_key.pem
â”‚       â””â”€â”€ device_cert.pem
â””â”€â”€ issuer_keys/            # Company keys
    â”œâ”€â”€ issuer_public_key.pem
    â””â”€â”€ issuer_private_key.pem
```

## ğŸš¨ Troubleshooting

### **Common Issues**

#### **1. Device ID Not Found**
```bash
# Check if device registration was run
sudo python3 test_device_environment.py

# If not configured, run registration
sudo python3 device_registration.py
```

#### **2. Permission Denied**
```bash
# Ensure proper permissions
sudo chmod 600 /etc/warhammer/device.env
sudo chmod 600 /etc/warhammer/systemd.env
sudo chmod 700 /etc/warhammer/device_keys/
```

#### **3. Environment Not Loading**
```bash
# Check if app is loading environment
export SERVER_DEBUG=true
python3 app.py

# Look for environment loading messages
```

#### **4. License Check Failing**
```bash
# Verify device ID is accessible
python3 -c "
import os
from utils.license_decorators import get_current_device_id
print(f'Device ID: {get_current_device_id()}')
"
```

### **Debug Mode**
Enable debug logging to see detailed device ID resolution:
```bash
export SERVER_DEBUG=true
python3 app.py
```

## ğŸ”„ Update Process

### **Automatic Updates**
The update script (`update.sh`) automatically:
1. Runs device registration
2. Updates environment files
3. Restarts the application

### **Manual Updates**
```bash
# Update environment only
sudo python3 device_registration.py --env-only

# Full update
sudo python3 device_registration.py --force
```

## ğŸ”’ Security Considerations

### **File Permissions**
- Environment files: `600` (owner read/write only)
- Key directories: `700` (owner read/write/execute only)
- Private keys: `600` (owner read/write only)

### **Environment Isolation**
- Device environment is loaded at app startup
- Environment variables are process-local
- No system-wide environment pollution

## ğŸ“‹ Integration with License System

### **License Decorators**
```python
@app.route('/api/peers')
@protected_route
@license_required(['peers', 'network'])
def get_peers():
    # Device ID automatically resolved by decorator
    return jsonify(peers)
```

### **Manual Device ID Access**
```python
from utils.license_decorators import get_current_device_id

device_id = get_current_device_id()
if device_id:
    # Use device ID for license checks
    pass
```

## ğŸ‰ Success Indicators

Your device environment is properly configured when:
- âœ… `test_device_environment.py` passes all checks
- âœ… Environment variables are set and accessible
- âœ… License decorators can resolve device ID
- âœ… No "Device ID not found" errors in logs
- âœ… License enforcement works correctly

## ğŸ“ Support

If you encounter issues:
1. Run `test_device_environment.py` for diagnostics
2. Check file permissions and ownership
3. Verify device registration completed successfully
4. Enable debug logging for detailed information
